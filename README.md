# Построение графиков на основе публичных данных о ДЭГ в Москве в 2021г.

## Описание

Скрипты в данном репозитории позволяют собственноручно построить графики распределения голосов избирателей по времени на основе публичных данных от системы Дистанционного Электронного Голосования Москвы для выборов в Государственную Думу 2021 года. Получаемые графики **не учитывают переголосования**, так как на настощий момент на основе публичных данных разделить бюллетени проголосовавшие единожды и переголосовавшие невозможно. Дополнительно можно построить распределение электронной "явки" по номеру блока регистрации избирателей, где также наблюдаются аномалии.

## Для кого предназначено это руководство

Для людей которые хотели бы собственноручно проанализировать публично доступные данные о дистанционном голосовании, но не обладают достаточным техническим уровнем или желанием разбираться для полностью самостоятельного разворачивания базы данных. Соответственно инструкция написана максимально подробно, насколько это возможно. Руководство разделено на установку (выполняется однажды) и собственно построение графиков.

## Установка

### Система 

Скрипты для построения графиков не должны зависеть от ОС, но на настоящий момент протестированы только под Linux. Установочные скрипты и инструкции рассчитаны на использование дистрибутивов Debian или Ubuntu. Для работы из под Windows или macOS (а для повышения безопасности и под Linux) рекомендуется воспользоваться виртуальной машиной с Ubuntu 20.04. Подойдёт например [VirtualBox](https://www.virtualbox.org/wiki/Downloads) с [вот этим образом](https://www.linuxvmimages.com/images/ubuntu-2004/). Установка VirtualBox достаточно проста, при необходимости инструкцию легко найти. Для подключения образа достаточно его распаковать, выполнить "Файл"-"Импорт конфигураций" и выбрать распакованный файл ova. После завершения импорта в настройках созданной виртуалки в разделе "Сеть" рекомендуется сменить тип подключения на NAT, при наличии достаточных ресурсов рекомендуется увеличить объём оперативной памяти до 8 ГБайт, остальные параметры можно оставить по-умолчанию. Системный пароль в виртуалке по ссылке выше - "ubuntu".

### Клонирование репозитория и получение SQL-дампа

Для получения файлов из данного репозитория необходимо установить git и выполнить клонирование. Для этого необходимо открыть терминал (в Ubuntu нажать Activities, набрать term и нажать Enter) и выполнить в нем:
```console
sudo apt update && sudo apt install -y git
git clone https://github.com/50000-Quaoar/election2021_msk
```

Для работы также понадобится дамп базы данных голосования, скачать который можно с сайта https://observer.mos.ru . Например данные по одномандатным округам доступны [на этой странице](https://observer.mos.ru/all/servers/1/txs), кнопка "Скачать sql dump". Если используете виртуальную машину - скачивайте сразу из неё. Данные по партийным спискам [здесь](https://observer.mos.ru/all/servers/2/txs). 

*Update:* 
observer.mos.ru в последнее время тормозит и не всегда открывается, а дампы могут скачаться битыми (правильные gz-файлы дампов для голосований в Госдуму имеют размер >3 ГБайт). Если скачать дампы с observer не удаётся, то можно попробовать воспользоваться следующими ссылками: [одномандатники](http://e.pc.cd/w4uotalK), [партии](http://e.pc.cd/lGWotalK). **При скачивании дампов из неофициальных источников, обязательно проверяйте их чексуммы.**

Точно корректность дампа можно проверить посчитав чексумму следующим образом (займет несколько минут):
```console
gunzip -kc observer-20210927_233000.sql.gz | sha256sum
```
SHA256 чексумма для распакованного дампа одномандатников: af3ca1f9002a7bc92065fd696e642fca84691dff7a3d8ee5165c009513082c66, а для партийных списков: 63f0cea15928ed31b1dceaaa74d2651fd901be17624bd2435ea925037fa3abec . В теории дампы после 19.09 меняться не должны, соответственно их чексуммы тоже.

### Установка зависимостей и импорт базы данных

Для установки зависимостей выполнить в терминале:
```console
cd election2021_msk/install
./install_ubuntu.sh
```

Для импорта базы данных в том же терминале исполняем:
```console
./import_db.sh /home/ubuntu/Downloads/observer-20210921_143000.sql.gz v2021_om
```
, где /home/ubuntu/Downloads/observer-20210921_143000.sql.gz - путь до скачанного дампа базы данных, а v2021_om - желаемое имя базы данных. В зависимости от производительности вашего компьютера и ресурсов виртуалки импорт может занять от нескольких минут до ~2 часов. Терминал не закрываем. Если помимо одномандатников есть желание анализировать и другие голосования (партийные списки, Мосгордума), то необходимо эту операцию повторить с другим именем файла и названием базы.

### Дорасшифровывание бюллетеней

В публично доступной на https://observer.mos.ru базе данных расшифровывание бюллетеней не была произведено до конца (подробности см. например в [статье на Хабре на тему ДЭГ](https://habr.com/ru/post/579350/)). Чтобы исправить это прискорбное недоразумение необходимо выполнить:

```console
cd ..
./decrypt_ballots.py --dbname v2021_om
```
, где v2021_om - выбранное имя базы данных. В зависимости от производительности вашего компьютера и ресурсов виртуалки расшифровывание может занять **вплоть до нескольких часов**. После завершения расшифровки база данных готова к использованию и можно переходить к построению графиков и анализу данных. Строить графики можно и без дорасшифровывания или не дожидаясь его завершения, но тогда часть голосов не будет учтена. Если анализируете несколько баз, то надо дорасшифровывать их все.

## Построение графиков

Для построения графика распределения голосов по времени достаточно вызвать в терминале:

```console
./time_plot.py -c plot-config.json --dbname v2021_om
```
, где plot-config.json - JSON файл с конфигурацией желаемого графика (по-умолчанию plot-config.json), а v2021_om - название базы данных. Полный help можно получить выполнив:
```console
./time_plot.py -h
```

Для построения графика явки в зависимости от номера блока регистрации избирателей используется другой скрипт:
```console
./turnout_plot.py --dbname v2021_om
```
, где v2021_om - название базы данных, других параметров не требуется. Скрипт построит три графика - распределение явки по блокам регистрации избирателей, распределение времени выдачи бюллетеня по блокам и распределение времени выдачи бюллетеня в зависимости от явки.

### Выбор данных для построения графика распределения по времени

Параметры графиков задаются в виде текстовых JSON-файлов. Параметр *minutes_in_bin* задаёт число минут на каждую точку по оси X (рекомендуемые значения от 10 до 60). Параметр *minutes_per_axis_tick* - частоту подписей времени по X. Параметр percentage выбирает отображать ли на графике абсолютное количество голосов (false) или процент голосов в данном временном интервале каждого отдельного кандидата от всех кандидатов на графике (true). Параметр *integrate* позволяет отобразить сумму (true) всех голосов за кандидата к текущему моменту.

Наконец наиболее важный параметр *candidates_to_plot* задаёт список (в квадратных скобках) ID кандидатов, которых необходимо отобразить на графике. ID интересующего вас кандидата можно узнать запустив time_plot.py с опцией -l номер_округа. Например:
```console
./time_plot.py -l 198
```
выведет список кандидатов в 198 округе, а для получения полного списка используйте опцию -l 0.

Время построения каждого графика обычно не превышает пары минут.

### Примеры JSON-файлов

В репозитории представлено несколько JSON файлов для примера графиков по одномандатным округам:
**198_perc.json** - процентное распределение голосов по времени за всех кандидатов по 198 округу;
**198_integral.json** - полное количество голосов к ка времени за всех кандидатов по 198 округу;
**208_abs.json** - распределение голосов по времени за всех кандидатов по 208 округу;
**sobyanin_list.json** - распределение голосов по времени за всех "административных" кандидатов по всем округам Москвы, позволяет проследить схожесть динамики набора голосов, в частности т.н. "перерыв на обед" в воскресенье днем;
**obed.json** - распределение голосов по времени за трех административных кандидатов по разным округам и трех их основных конкурентов, позволяет проследить отличие в динамике числа голосов за административных и опозиционных кандидатов, в особенности в воскресенье (стремительное набор голосов за административных в 6:30 утра, отсутствие "обеда" у опозиционных голосов и резкое снижение административных после 14:30);
**party.json** - распределение голосов по времени по партийным спискам, обед у ЕР присутствует;

### Примеры графиков

Графики для конфигураций описанных выше, некоторые приближены для наглядности.

**198_perc.json**

![alt text](images/198_perc.png)

**198_integral.json**

![alt text](images/198_integral.png)

**208_abs.json**

![alt text](images/208_abs.png)

**sobyanin_list.json**

![alt text](images/sobyanin_list.png)

**obed.json**

![alt text](images/obed.png)

**party.json**

![alt text](images/party.png)

**198_perc.json нормированный на официальные результаты**

![alt text](images/198_norm.png)

**turnout_plot.py для одномандатных округов**

![alt text](images/turnout_blocks.png)

## Лицензия

Лицензия на все файлы этого репозитория кроме choices_pb2.py и decrypt_ballots.py - public domain (общественное достояние - приветствуется любое использование и распространение).

Файлы choices_pb2.py и decrypt_ballots.py содержат заимствования из https://gist.github.com/SaveTheRbtz/246eab8557b0217ab3945e15cef6ffe8 , где лицензия не определена.

## TODO

- Добавить построение других типов графиков.
- Ускорить расшифрование.
- Замечания и вопросы приветствуются :).
